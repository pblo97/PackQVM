#!/usr/bin/env python3
"""
DiagnÃ³stico: Â¿Por quÃ© el filtro MA200 rechaza tantos stocks?

AnÃ¡lisis del problema reportado:
- Input: 155 stocks
- Rejected by MA200: 69 (44.5%)
- Output: 83 stocks

Â¿Es esto normal? Â¿EstÃ¡ filtrando correctamente?
"""

print("=" * 80)
print("ðŸ” ANÃLISIS DEL FILTRO MA200")
print("=" * 80)
print()

print("ðŸ“Š DATOS REPORTADOS:")
print("-" * 80)
print(f"Input al PASO 7:        155 stocks")
print(f"Rejected by MA200:      69 stocks (44.5%)")
print(f"Rejected by Momentum:   3 stocks (1.9%)")
print(f"Output final:           83 stocks (53.5%)")
print()

print("=" * 80)
print("ðŸ¤” INTERPRETACIÃ“N")
print("=" * 80)
print()

print("1ï¸âƒ£  Â¿Es normal que 44.5% estÃ©n bajo MA200?")
print()
print("   âœ… SÃ, es completamente normal.")
print()
print("   En mercados tÃ­picos:")
print("   - Tendencia alcista: 60-70% sobre MA200")
print("   - Mercado lateral:   40-60% sobre MA200")
print("   - Tendencia bajista: 20-40% sobre MA200")
print()
print("   Si 55.5% pasaron el filtro (86/155), estamos en:")
print("   â†’ Mercado LATERAL o inicio de recuperaciÃ³n")
print()

print("2ï¸âƒ£  Â¿El filtro estÃ¡ funcionando correctamente?")
print()
print("   Para verificarlo, necesitamos saber:")
print()
print("   A) Â¿CuÃ¡ntos del universo TOTAL estÃ¡n sobre MA200?")
print("      - Si universo = 800 stocks")
print("      - Y solo 155 llegaron al PASO 7")
print("      - Ya hubo mucho filtrado previo")
print()
print("   B) Â¿Los 69 rechazados estÃ¡n REALMENTE bajo MA200?")
print("      - Esto requiere verificaciÃ³n con datos actuales")
print()

print("=" * 80)
print("ðŸŽ¯ POSIBLES PROBLEMAS")
print("=" * 80)
print()

print("Escenario A: FUNCIONAMIENTO NORMAL")
print("-" * 80)
print("âœ… El mercado estÃ¡ lateral/bajista")
print("âœ… Muchos stocks estÃ¡n bajo MA200 (normal)")
print("âœ… El filtro estÃ¡ haciendo su trabajo")
print()
print("SoluciÃ³n: Ninguna, es el comportamiento esperado")
print()

print("Escenario B: DATOS DESACTUALIZADOS")
print("-" * 80)
print("âš ï¸  Los datos de MA200 son viejos")
print("âš ï¸  Stocks que YA estÃ¡n sobre MA200 se marcan como bajo")
print("âš ï¸  El cachÃ© tiene datos de hace dÃ­as/semanas")
print()
print("SoluciÃ³n:")
print("  1. Haz clic en 'ðŸ—‘ï¸ Limpiar CachÃ©'")
print("  2. Re-ejecuta el screener")
print("  3. Verifica que 'last_date' en datos sea reciente")
print()

print("Escenario C: FILTRO MA200 DEMASIADO ESTRICTO")
print("-" * 80)
print("âš ï¸  Quieres TODOS los stocks, no solo sobre MA200")
print("âš ï¸  El filtro estÃ¡ activado pero no lo quieres")
print()
print("SoluciÃ³n:")
print("  1. Desmarca el checkbox 'Filtro MA200'")
print("  2. VerÃ¡s TODOS los stocks (155 â†’ 152 despuÃ©s de momentum)")
print("  3. La columna 'above_ma200' seguirÃ¡ presente para referencia")
print()

print("Escenario D: BREAKOUT FILTER NO SE ESTÃ APLICANDO")
print("-" * 80)
print("âš ï¸  Activaste el filtro de breakout pero no aparece en logs")
print("âš ï¸  El PASO 8 no muestra mÃ©tricas de breakout")
print()
print("SoluciÃ³n:")
print("  1. Verifica que 'enable_breakout_filter' estÃ© marcado")
print("  2. Busca en la salida el PASO 8")
print("  3. Debe decir 'Breakouts detectados (Ãºltimos 5 dÃ­as)'")
print()

print("=" * 80)
print("ðŸ“‹ ACCIONES RECOMENDADAS")
print("=" * 80)
print()

print("1. VERIFICA EL ESTADO DEL MERCADO:")
print("   - Â¿Estamos en tendencia alcista o bajista?")
print("   - Si es bajista, es normal que muchos estÃ©n bajo MA200")
print()

print("2. VERIFICA LA CONFIGURACIÃ“N:")
print("   - Â¿Tienes el checkbox 'Filtro MA200' marcado?")
print("   - Si NO lo quieres, desmÃ¡rcalo")
print("   - Si SÃ lo quieres, estÃ¡ funcionando correctamente")
print()

print("3. VERIFICA LOS DATOS:")
print("   - Limpia el cachÃ©")
print("   - Re-ejecuta")
print("   - Verifica que la fecha de los datos sea reciente")
print()

print("4. MUÃ‰STRAME LA SALIDA COMPLETA:")
print("   - Copia TODO desde PASO 1 hasta PASO 10")
print("   - Especialmente PASO 7 y PASO 8")
print("   - AsÃ­ puedo ver quÃ© estÃ¡ pasando exactamente")
print()

print("=" * 80)
print("ðŸ”§ DEBUGGING RÃPIDO")
print("=" * 80)
print()

print("Ejecuta este comando para ver quÃ© % del universo estÃ¡ sobre MA200:")
print()
print("  python3 -c \"")
print("  from data_fetcher import fetch_screener")
print("  from momentum_calculator import is_above_ma200")
print("  from data_fetcher import fetch_prices")
print("  from datetime import datetime, timedelta")
print()
print("  universe = fetch_screener(limit=100)")
print("  above_count = 0")
print("  total = 0")
print()
print("  for symbol in universe['symbol'].head(20):")
print("      end = datetime.now().strftime('%Y-%m-%d')")
print("      start = (datetime.now() - timedelta(days=300)).strftime('%Y-%m-%d')")
print("      prices = fetch_prices(symbol, start, end, use_cache=False)")
print("      if len(prices) >= 200:")
print("          if is_above_ma200(prices):")
print("              above_count += 1")
print("          total += 1")
print()
print("  print(f'{above_count}/{total} sobre MA200 ({100*above_count/total:.1f}%)')")
print("  \"")
print()

print("=" * 80)
