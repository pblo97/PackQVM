#!/usr/bin/env python3
"""
Debug especÃ­fico para PYPL y el filtro MA200
"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

import pandas as pd
from datetime import datetime, timedelta

print("="*80)
print("ðŸ” DIAGNÃ“STICO: PYPL y Filtro MA200")
print("="*80)
print()

# AnÃ¡lisis de la lÃ³gica
print("ðŸ“‹ ANÃLISIS DE LA LÃ“GICA DEL FILTRO MA200:")
print()

print("1ï¸âƒ£  DONDE SE APLICA EL FILTRO:")
print("   Archivo: qvm_pipeline_v3.py")
print("   LÃ­nea: 876-880")
print()
print("   CÃ³digo:")
print("   ```python")
print("   if config.require_above_ma200:")
print("       df_merged = df_merged[df_merged['above_ma200'] == True].copy()")
print("   ```")
print()

print("2ï¸âƒ£  COMO SE CALCULA above_ma200:")
print("   Archivo: momentum_calculator.py")
print("   FunciÃ³n: is_above_ma200(prices)")
print()
print("   LÃ³gica:")
print("   - Obtiene precio actual: prices['close'].iloc[-1]")
print("   - Calcula MA200: prices['close'].rolling(200).mean().iloc[-1]")
print("   - Retorna: precio_actual > ma200")
print()

print("3ï¸âƒ£  POSIBLES CAUSAS DEL PROBLEMA:")
print()

print("âŒ CAUSA #1: Filtro NO activado")
print("   Verificar: En Streamlit, checkbox 'Filtro MA200' debe estar marcado")
print("   SÃ­ntoma: Si el usuario ve stocks bajo MA200 en resultados")
print("   SoluciÃ³n: Marcar el checkbox y re-ejecutar")
print()

print("âŒ CAUSA #2: Datos de precios desactualizados (CACHÃ‰)")
print("   Problema: Los precios se obtienen con use_cache=True")
print("   Archivo: qvm_pipeline_v3.py lÃ­nea 821")
print("   CÃ³digo: prices = fetch_prices(symbol, start=..., end=..., use_cache=True)")
print()
print("   ðŸš¨ ESTE ES PROBABLEMENTE EL PROBLEMA!")
print()
print("   Si los datos fueron cacheados hace dÃ­as/semanas:")
print("   - El precio 'actual' en el cache puede estar sobre MA200")
print("   - Pero el precio REAL de hoy puede estar BAJO MA200")
print("   - El usuario ve resultados desactualizados")
print()
print("   SoluciÃ³n:")
print("   - En Streamlit, clic en 'ðŸ—‘ï¸ Limpiar CachÃ©'")
print("   - Re-ejecutar el screener")
print()

print("âŒ CAUSA #3: La columna 'above_ma200' no corresponde al filtro aplicado")
print("   Problema: La columna se calcula en PASO 7 pero se muestra sin verificar")
print("   Verificar: Â¿Los datos en pantalla son del run actual o de un run anterior?")
print()

print("4ï¸âƒ£  VERIFICACIÃ“N DIRECTA:")
print()
print("   Para verificar si PYPL estÃ¡ realmente sobre MA200 HOY:")
print()
print("   Option A - Con API key:")
print("   $ export FMP_API_KEY=tu_key")
print("   $ python3 quick_check_ma200.py")
print()
print("   Option B - VerificaciÃ³n manual:")
print("   1. Ir a https://finance.yahoo.com/quote/PYPL")
print("   2. Mirar el grÃ¡fico con MA200")
print("   3. Comparar precio actual vs MA200")
print()

print("5ï¸âƒ£  SOLUCIÃ“N INMEDIATA:")
print()
print("   ðŸŽ¯ SI EL PROBLEMA ES CACHE (mÃ¡s probable):")
print("   1. Abrir app Streamlit")
print("   2. Clic en 'ðŸ—‘ï¸ Limpiar CachÃ©' en la barra lateral")
print("   3. Verificar que 'Filtro MA200' estÃ© MARCADO")
print("   4. Ejecutar 'ðŸš€ Ejecutar Screening V3'")
print("   5. Verificar en la salida:")
print("      - 'âœ… PASO 7: Momentum + MA200 Filter'")
print("      - 'MA200 Filter: ENABLED'")
print("      - 'Rejected by MA200: X' (debe ser > 0)")
print()

print("   ðŸŽ¯ SI EL PROBLEMA PERSISTE:")
print("   1. El filtro puede necesitar modificaciÃ³n para forzar")
print("      recarga de datos sin cache")
print("   2. Reportar el issue con:")
print("      - Screenshot de la salida del PASO 7")
print("      - Lista de sÃ­mbolos problemÃ¡ticos")
print("      - Fecha/hora de ejecuciÃ³n")
print()

print("="*80)
print("ðŸ“Š DATOS DE LA TABLA DEL USUARIO:")
print("="*80)
print()
print("SÃ­mbolos mencionados:")
print("- BRFS: âœ… (Row 0)")
print("- ZIM: âœ… (Row 1)")
print("- UNVR: âœ… (Row 2)")
print("- DFS: âœ… (Row 3)")
print("- SKX: âœ… (Row 4)")
print("- VRTV: âœ… (Row 5)")
print("- NCLH: âœ… (Row 6)")
print("- AEL: âœ… (Row 7)")
print("- DPM.TO: âœ… (Row 8)")
print("- PYPL: âœ… (Row 9) <-- Usuario dice que estÃ¡ BAJO MA200")
print("- K.TO: âœ… (Row 10)")
print("- DCP: âœ… (Row 11)")
print("- SWI: âœ… (Row 12)")
print("- AMK: âœ… (Row 13)")
print("- IBTX: âœ… (Row 14)")
print()
print("Todos muestran âœ… en la columna above_ma200")
print()

print("="*80)
print("ðŸ”¬ HIPÃ“TESIS PRINCIPAL:")
print("="*80)
print()
print("CACHE DE DATOS DESACTUALIZADOS")
print()
print("RazÃ³n:")
print("- El pipeline usa use_cache=True al descargar precios")
print("- Si los datos fueron cacheados hace dÃ­as/semanas:")
print("  * En ese momento, PYPL estaba sobre MA200 â†’ âœ…")
print("  * Hoy, PYPL estÃ¡ bajo MA200")
print("  * Pero el usuario ve datos del cache antiguo")
print()
print("Evidencia:")
print("- Usuario dice 'PYPL no ha hecho mÃ¡s que estar estancada'")
print("- Esto sugiere que PYPL ha tenido mala performance recientemente")
print("- PodrÃ­a haber caÃ­do bajo MA200 recientemente")
print()
print("âœ… SOLUCIÃ“N: Limpiar cache y re-ejecutar")
print()
print("="*80)
